<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTSè¯­éŸ³æ’­æŠ¥åŠŸèƒ½æ¼”ç¤º</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .demo-section {
            margin: 2rem 0;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
        }

        .feature-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 0.5rem 0;
            background-color: white;
        }

        .btn-tts {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            color: white;
        }

        .btn-tts:hover {
            background: linear-gradient(45deg, #0056b3, #003d82);
            color: white;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-success {
            background-color: #28a745;
        }

        .status-warning {
            background-color: #ffc107;
        }

        .status-error {
            background-color: #dc3545;
        }

        .tts-demo-text {
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 0.375rem;
            margin: 1rem 0;
            border-left: 4px solid #007bff;
        }

        .voice-option {
            padding: 0.5rem;
            margin: 0.25rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .voice-option:hover {
            background-color: #e9ecef;
        }

        .voice-option.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <div class="row">
            <div class="col-12">
                <!-- é¡µé¢å¤´éƒ¨ -->
                <div class="text-center mb-4">
                    <h1 class="display-4">ğŸµ TTSè¯­éŸ³æ’­æŠ¥åŠŸèƒ½æ¼”ç¤º</h1>
                    <p class="lead">ASR-LLM-TTSæ™ºèƒ½åŠ©æ‰‹ - åŸºäºé˜¿é‡Œäº‘DashScope CosyVoice v2</p>
                </div>

                <!-- æœåŠ¡çŠ¶æ€æ£€æŸ¥ -->
                <div class="demo-section">
                    <h3><i class="fas fa-server me-2"></i>æœåŠ¡çŠ¶æ€æ£€æŸ¥</h3>
                    <div class="d-flex align-items-center">
                        <span class="status-indicator status-warning" id="statusIndicator"></span>
                        <span id="statusText">æ£€æŸ¥ä¸­...</span>
                        <button class="btn btn-sm btn-outline-primary ms-auto" onclick="checkServerStatus()">
                            <i class="fas fa-sync-alt"></i> åˆ·æ–°çŠ¶æ€
                        </button>
                    </div>
                </div>

                <!-- åŠŸèƒ½ç‰¹æ€§ä»‹ç» -->
                <div class="demo-section">
                    <h3><i class="fas fa-star me-2"></i>åŠŸèƒ½ç‰¹æ€§</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="feature-card">
                                <h5><i class="fas fa-volume-up text-primary"></i> è‡ªåŠ¨è¯­éŸ³æ’­æŠ¥</h5>
                                <p>AIå›å¤è‡ªåŠ¨æ’­æ”¾è¯­éŸ³ï¼Œæ”¯æŒå¼€å¯/å…³é—­</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="feature-card">
                                <h5><i class="fas fa-play-circle text-success"></i> æ‰‹åŠ¨è¯­éŸ³æ’­æŠ¥</h5>
                                <p>é’ˆå¯¹ç‰¹å®šå†…å®¹ç‚¹å‡»æœ—è¯»æŒ‰é’®æ’­æ”¾</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="feature-card">
                                <h5><i class="fas fa-microphone text-info"></i> å¤šç§è¯­éŸ³é€‰æ‹©</h5>
                                <p>æ”¯æŒ7ç§ä¸åŒçš„ä¸­æ–‡è¯­éŸ³ï¼ˆç”·å£°/å¥³å£°ï¼‰</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="feature-card">
                                <h5><i class="fas fa-cloud text-warning"></i> äº‘ç«¯è¯­éŸ³åˆæˆ</h5>
                                <p>åŸºäºé˜¿é‡Œäº‘DashScopeçš„é«˜è´¨é‡è¯­éŸ³åˆæˆ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¯­éŸ³é€‰æ‹© -->
                <div class="demo-section">
                    <h3><i class="fas fa-user-friends me-2"></i>è¯­éŸ³é€‰æ‹©</h3>
                    <div class="row" id="voiceOptions">
                        <!-- è¯­éŸ³é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- TTSæ¼”ç¤º -->
                <div class="demo-section">
                    <h3><i class="fas fa-magic me-2"></i>TTSæ¼”ç¤º</h3>

                    <!-- é¢„è®¾æ¼”ç¤ºæ–‡æœ¬ -->
                    <div class="mb-3">
                        <h5>é¢„è®¾æ¼”ç¤ºæ–‡æœ¬ï¼š</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-outline-secondary btn-sm w-100 mb-2"
                                    onclick="setDemoText('æ¬¢è¿ä½¿ç”¨ASR-LLM-TTSæ™ºèƒ½åŠ©æ‰‹ï¼è¿™æ˜¯ä¸€ä¸ªé›†æˆäº†è¯­éŸ³è¯†åˆ«ã€å¤§è¯­è¨€æ¨¡å‹å¯¹è¯å’Œè¯­éŸ³åˆæˆçš„æ™ºèƒ½åŠ©æ‰‹ç³»ç»Ÿã€‚')">
                                    æ¬¢è¿ä»‹ç»
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-secondary btn-sm w-100 mb-2"
                                    onclick="setDemoText('äººå·¥æ™ºèƒ½æŠ€æœ¯çš„å‘å±•æ­£åœ¨æ”¹å˜æˆ‘ä»¬çš„ç”Ÿæ´»æ–¹å¼ã€‚ä»è¯­éŸ³è¯†åˆ«åˆ°è‡ªç„¶è¯­è¨€å¤„ç†ï¼ŒAIæ­£åœ¨å„ä¸ªé¢†åŸŸå‘æŒ¥é‡è¦ä½œç”¨ã€‚')">
                                    æŠ€æœ¯ä»‹ç»
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-secondary btn-sm w-100 mb-2"
                                    onclick="setDemoText('ä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼Œé˜³å…‰æ˜åªšï¼Œå¾®é£å¾å¾ã€‚æ­£æ˜¯å‡ºé—¨æ•£æ­¥çš„å¥½æ—¶å…‰ã€‚')">
                                    æ—¥å¸¸å¯¹è¯
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰æ–‡æœ¬è¾“å…¥ -->
                    <div class="mb-3">
                        <label for="ttsText" class="form-label">è‡ªå®šä¹‰æ–‡æœ¬ï¼š</label>
                        <textarea class="form-control" id="ttsText" rows="3"
                            placeholder="è¯·è¾“å…¥è¦è½¬æ¢ä¸ºè¯­éŸ³çš„æ–‡æœ¬...">æ¬¢è¿ä½¿ç”¨ASR-LLM-TTSæ™ºèƒ½åŠ©æ‰‹çš„è¯­éŸ³æ’­æŠ¥åŠŸèƒ½ï¼</textarea>
                    </div>

                    <!-- æ’­æ”¾æ§åˆ¶ -->
                    <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-tts" onclick="playTTS()" id="playBtn">
                            <i class="fas fa-play"></i> æ’­æ”¾è¯­éŸ³
                        </button>
                        <button class="btn btn-outline-danger" onclick="stopTTS()" id="stopBtn" disabled>
                            <i class="fas fa-stop"></i> åœæ­¢æ’­æ”¾
                        </button>
                        <div class="flex-grow-1"></div>
                        <span class="text-muted" id="ttsStatus">å‡†å¤‡å°±ç»ª</span>
                    </div>

                    <!-- éŸ³é¢‘æ’­æ”¾å™¨ï¼ˆéšè—ï¼‰ -->
                    <audio id="audioPlayer" style="display: none;" controls></audio>
                </div>

                <!-- ä½¿ç”¨è¯´æ˜ -->
                <div class="demo-section">
                    <h3><i class="fas fa-info-circle me-2"></i>ä½¿ç”¨è¯´æ˜</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <h5>ğŸ–¥ï¸ Webç•Œé¢ä½¿ç”¨</h5>
                            <ol>
                                <li>è®¿é—®ä¸»é¡µé¢ http://localhost:5000</li>
                                <li>ç‚¹å‡»å·¦ä¾§è¾¹æ "å¼€å¯è¯­éŸ³"å¯ç”¨è‡ªåŠ¨æ’­æŠ¥</li>
                                <li>å‘é€æ¶ˆæ¯åAIå›å¤ä¼šè‡ªåŠ¨æ’­æ”¾è¯­éŸ³</li>
                                <li>ä¹Ÿå¯ç‚¹å‡»å›å¤ä¸‹æ–¹çš„"ğŸ”Š æœ—è¯»"æŒ‰é’®æ‰‹åŠ¨æ’­æ”¾</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <h5>ğŸ™ï¸ è¯­éŸ³è¯†åˆ«ç»“åˆä½¿ç”¨</h5>
                            <ol>
                                <li>ç‚¹å‡»"å¼€å§‹å½•éŸ³"æŒ‰é’®</li>
                                <li>è¯´è¯å®Œæˆåç‚¹å‡»"åœæ­¢å½•éŸ³"</li>
                                <li>è¯†åˆ«ç»“æœè‡ªåŠ¨å¡«å…¥è¾“å…¥æ¡†</li>
                                <li>ç‚¹å‡»"å‘é€"æŒ‰é’®ï¼ŒAIå›å¤å°†è‡ªåŠ¨æ’­æ”¾è¯­éŸ³</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- APIç¤ºä¾‹ -->
                <div class="demo-section">
                    <h3><i class="fas fa-code me-2"></i>APIè°ƒç”¨ç¤ºä¾‹</h3>
                    <pre class="bg-dark text-light p-3 rounded"><code>// JavaScriptå‰ç«¯è°ƒç”¨
async function callTTSAPI(text, voice = 'longxiaochun_v2') {
    const response = await fetch('/tts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: text, voice: voice })
    });
    
    const data = await response.json();
    if (data.success) {
        // æ’­æ”¾è¿”å›çš„Base64éŸ³é¢‘æ•°æ®
        playAudioFromBase64(data.audio);
    }
}</code></pre>
                </div>

                <!-- åº•éƒ¨é“¾æ¥ -->
                <div class="text-center mt-4">
                    <a href="http://localhost:5000" class="btn btn-primary btn-lg me-3">
                        <i class="fas fa-home"></i> è¿”å›ä¸»é¡µé¢
                    </a>
                    <a href="TTSåŠŸèƒ½ä½¿ç”¨è¯´æ˜.md" class="btn btn-outline-primary btn-lg">
                        <i class="fas fa-book"></i> è¯¦ç»†è¯´æ˜æ–‡æ¡£
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentAudio = null;
        let selectedVoice = 'longxiaochun_v2';

        // å¯ç”¨è¯­éŸ³åˆ—è¡¨
        const voices = {
            'longxiaochun_v2': { name: 'é¾™å°æ˜¥', gender: 'å¥³å£°', description: 'æ¸©æŸ”ç”œç¾' },
            'longxiaoxia_v2': { name: 'é¾™å°å¤', gender: 'å¥³å£°', description: 'æ´»æ³¼å¼€æœ—' },
            'longwan_v2': { name: 'é¾™ä¸‡', gender: 'ç”·å£°', description: 'æˆç†Ÿç¨³é‡' },
            'longcheng_v2': { name: 'é¾™åŸ', gender: 'ç”·å£°', description: 'ç£æ€§ä½æ²‰' },
            'longhua_v2': { name: 'é¾™å', gender: 'ç”·å£°', description: 'æ¸…æ™°æ ‡å‡†' },
            'longshu_v2': { name: 'é¾™ä¹¦', gender: 'ç”·å£°', description: 'ä¹¦å·æ°”æ¯' },
            'loongbella_v2': { name: 'Bella', gender: 'å¥³å£°', description: 'ä¼˜é›…çŸ¥æ€§' }
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            checkServerStatus();
            generateVoiceOptions();
        });

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServerStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            try {
                const response = await fetch('/health');
                if (response.ok) {
                    statusIndicator.className = 'status-indicator status-success';
                    statusText.textContent = 'æœåŠ¡å™¨è¿è¡Œæ­£å¸¸ âœ…';
                } else {
                    statusIndicator.className = 'status-indicator status-error';
                    statusText.textContent = 'æœåŠ¡å™¨å“åº”å¼‚å¸¸ âŒ';
                }
            } catch (error) {
                statusIndicator.className = 'status-indicator status-error';
                statusText.textContent = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ âŒ (è¯·å…ˆå¯åŠ¨Flaskåº”ç”¨)';
            }
        }

        // ç”Ÿæˆè¯­éŸ³é€‰é¡¹
        function generateVoiceOptions() {
            const container = document.getElementById('voiceOptions');
            container.innerHTML = '';

            Object.keys(voices).forEach(voiceId => {
                const voice = voices[voiceId];
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';

                const isSelected = voiceId === selectedVoice ? 'selected' : '';
                col.innerHTML = `
                    <div class="voice-option ${isSelected}" onclick="selectVoice('${voiceId}')">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-${voice.gender === 'å¥³å£°' ? 'female' : 'male'} me-2"></i>
                            <div>
                                <strong>${voice.name}</strong>
                                <br><small class="text-muted">${voice.gender} - ${voice.description}</small>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        // é€‰æ‹©è¯­éŸ³
        function selectVoice(voiceId) {
            selectedVoice = voiceId;
            generateVoiceOptions();
        }

        // è®¾ç½®æ¼”ç¤ºæ–‡æœ¬
        function setDemoText(text) {
            document.getElementById('ttsText').value = text;
        }

        // æ’­æ”¾TTS
        async function playTTS() {
            const text = document.getElementById('ttsText').value.trim();
            if (!text) {
                alert('è¯·è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬');
                return;
            }

            const playBtn = document.getElementById('playBtn');
            const stopBtn = document.getElementById('stopBtn');
            const status = document.getElementById('ttsStatus');

            try {
                // æ›´æ–°UIçŠ¶æ€
                playBtn.disabled = true;
                status.textContent = 'æ­£åœ¨åˆæˆè¯­éŸ³...';

                // è°ƒç”¨TTS API
                const response = await fetch('/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        voice: selectedVoice
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // è½¬æ¢Base64ä¸ºéŸ³é¢‘å¹¶æ’­æ”¾
                    const audioData = atob(data.audio);
                    const arrayBuffer = new ArrayBuffer(audioData.length);
                    const uint8Array = new Uint8Array(arrayBuffer);

                    for (let i = 0; i < audioData.length; i++) {
                        uint8Array[i] = audioData.charCodeAt(i);
                    }

                    const audioBlob = new Blob([arrayBuffer], { type: 'audio/mp3' });
                    const audioUrl = URL.createObjectURL(audioBlob);

                    // åœæ­¢ä¹‹å‰çš„éŸ³é¢‘
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio = null;
                    }

                    // æ’­æ”¾æ–°éŸ³é¢‘
                    currentAudio = new Audio(audioUrl);

                    currentAudio.onplay = () => {
                        status.textContent = 'æ­£åœ¨æ’­æ”¾...';
                        stopBtn.disabled = false;
                    };

                    currentAudio.onended = () => {
                        status.textContent = 'æ’­æ”¾å®Œæˆ';
                        resetPlayButton();
                        URL.revokeObjectURL(audioUrl);
                    };

                    currentAudio.onerror = () => {
                        status.textContent = 'æ’­æ”¾å¤±è´¥';
                        resetPlayButton();
                        URL.revokeObjectURL(audioUrl);
                    };

                    await currentAudio.play();

                } else {
                    throw new Error(data.error || 'è¯­éŸ³åˆæˆå¤±è´¥');
                }

            } catch (error) {
                console.error('TTS Error:', error);
                status.textContent = `é”™è¯¯: ${error.message}`;
                resetPlayButton();
            }
        }

        // åœæ­¢æ’­æ”¾
        function stopTTS() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            document.getElementById('ttsStatus').textContent = 'å·²åœæ­¢';
            resetPlayButton();
        }

        // é‡ç½®æ’­æ”¾æŒ‰é’®çŠ¶æ€
        function resetPlayButton() {
            document.getElementById('playBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }
    </script>
</body>

</html>